{"version":3,"file":"preview.min.js","sources":["../src/preview.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Preview modal implementation.\n *\n * @copyright  2019 RvD <helpdesk@sebsoft.nl>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport * as Str from 'core/str';\nimport * as Notification from 'core/notification';\n\n/**\n * Encode uri parameters.\n *\n * @param {Object} data\n * @return {String}\n */\nconst encodeQueryParams = function (data) {\n    const ret = [];\n    for (let d in data) {\n        ret.push(encodeURIComponent(d) + '=' + encodeURIComponent(data[d]));\n    }\n    return ret.join('&');\n};\n\nclass CouponPreview {\n    /**\n     * RearrangeArea class.\n     *\n     * @param {String} selector\n     * @param {string} url\n     */\n    constructor(selector, url) {\n        this.selector = selector;\n        this.url = url;\n        Str.get_string('preview-pdf', 'block_coupon').then(function(title) {\n            this.title = title;\n            this.setupHandlers();\n        }.bind(this)).fail(Notification.exception);\n    }\n\n    /**\n     * @var {string} modal title\n     */\n    title = null;\n\n    /**\n     * @var {string} preview loader url\n     */\n    url = null;\n\n    /**\n     * @var {Object} modal\n     */\n    modal = null;\n\n    /**\n     * @var {string} click selector opening the modal\n     */\n    selector = null;\n\n    /**\n     * Close handler\n     */\n    closeHandler() {\n        this.destroy();\n    }\n\n    /**\n     * Out of bounds click handler handler\n     * @param {Event} e\n     */\n    clickOutHandler(e) {\n        if ($(e.target) == this.modal) {\n            this.destroy();\n        }\n    }\n\n    /**\n     * Handler to setup the modal\n     * @param {Event} e\n     */\n    setupHandler(e) {\n        var url = this.url, extraparams = {};\n        var el = e.currentTarget;\n        if (el.dataset.templated) {\n            extraparams.templateid = el.dataset.templateid;\n        } else {\n            extraparams.font = el.dataset.font;\n            extraparams.logoid = el.dataset.logo;\n            extraparams.qr = el.dataset.qr;\n        }\n\n        if (Object.keys(extraparams).length) {\n            if (url.indexOf('?') >= 0) {\n                url += '&' + encodeQueryParams(extraparams);\n            } else {\n                url += '?' + encodeQueryParams(extraparams);\n            }\n        }\n        // Create container.\n        var html = '<div id=\"block-coupon-modal\"><div class=\"block-coupon-modal-content\">';\n        html += '<div class=\"block-coupon-modal-header\">';\n        html += '<span id=\"block-modal-close\" class=\"close\">&times;</span>';\n        html += '<h2>' + this.title + '</h2>';\n        html += '</div>';\n        html += '<div class=\"block-coupon-modal-body\">';\n        html += '<iframe src=\"' + url + '\"></iframe>';\n        html += '</div>';\n        html += '</div></div>';\n        this.modal = $(html);\n        $('body').append(this.modal);\n        this.modal.hide();\n        $('#block-modal-close').on('click', this.destroy.bind(this));\n        $('body').on('click', this.clickOutHandler.bind(this));\n        this.modal.show();\n    }\n\n    /**\n     * Setup external handlers\n     */\n    setupHandlers() {\n        $(this.selector).on('click', this.setupHandler.bind(this));\n    }\n\n    /**\n     * Destroy the modal\n     */\n    destroy() {\n        // Destroy some handlers.\n        $('#block-modal-close').off('click');\n        $('body').off('click');\n        // Destroy modal container.\n        this.modal.hide();\n        this.modal.remove();\n    }\n\n}\n\nexport default {\n    init: function(clickselector, url) {\n        new CouponPreview(clickselector, url);\n    }\n};\n"],"names":["encodeQueryParams","data","ret","d","push","encodeURIComponent","join","CouponPreview","constructor","selector","url","Str","get_string","then","title","setupHandlers","bind","this","fail","Notification","exception","closeHandler","destroy","clickOutHandler","e","target","modal","setupHandler","extraparams","el","currentTarget","dataset","templated","templateid","font","logoid","logo","qr","Object","keys","length","indexOf","html","append","hide","on","show","off","remove","init","clickselector"],"mappings":"o8CAgCMA,kBAAoB,SAAUC,YAC1BC,IAAM,OACP,IAAIC,KAAKF,KACVC,IAAIE,KAAKC,mBAAmBF,GAAK,IAAME,mBAAmBJ,KAAKE,YAE5DD,IAAII,KAAK,YAGdC,cAOFC,YAAYC,SAAUC,kCAYd,iCAKF,mCAKE,sCAKG,WA1BFD,SAAWA,cACXC,IAAMA,IACXC,IAAIC,WAAW,cAAe,gBAAgBC,KAAK,SAASC,YACnDA,MAAQA,WACRC,iBACPC,KAAKC,OAAOC,KAAKC,aAAaC,WA0BpCC,oBACSC,UAOTC,gBAAgBC,IACR,mBAAEA,EAAEC,SAAWR,KAAKS,YACfJ,UAQbK,aAAaH,OACLd,IAAMO,KAAKP,IAAKkB,YAAc,GAC9BC,GAAKL,EAAEM,cACPD,GAAGE,QAAQC,UACXJ,YAAYK,WAAaJ,GAAGE,QAAQE,YAEpCL,YAAYM,KAAOL,GAAGE,QAAQG,KAC9BN,YAAYO,OAASN,GAAGE,QAAQK,KAChCR,YAAYS,GAAKR,GAAGE,QAAQM,IAG5BC,OAAOC,KAAKX,aAAaY,SACrB9B,IAAI+B,QAAQ,MAAQ,EACpB/B,KAAO,IAAMV,kBAAkB4B,aAE/BlB,KAAO,IAAMV,kBAAkB4B,kBAInCc,KAAO,wEACXA,MAAQ,0CACRA,MAAQ,4DACRA,MAAQ,OAASzB,KAAKH,MAAQ,QAC9B4B,MAAQ,SACRA,MAAQ,wCACRA,MAAQ,gBAAkBhC,IAAM,cAChCgC,MAAQ,SACRA,MAAQ,oBACHhB,OAAQ,mBAAEgB,0BACb,QAAQC,OAAO1B,KAAKS,YACjBA,MAAMkB,2BACT,sBAAsBC,GAAG,QAAS5B,KAAKK,QAAQN,KAAKC,2BACpD,QAAQ4B,GAAG,QAAS5B,KAAKM,gBAAgBP,KAAKC,YAC3CS,MAAMoB,OAMf/B,oCACME,KAAKR,UAAUoC,GAAG,QAAS5B,KAAKU,aAAaX,KAAKC,OAMxDK,8BAEM,sBAAsByB,IAAI,6BAC1B,QAAQA,IAAI,cAETrB,MAAMkB,YACNlB,MAAMsB,uBAKJ,CACXC,KAAM,SAASC,cAAexC,SACtBH,cAAc2C,cAAexC"}